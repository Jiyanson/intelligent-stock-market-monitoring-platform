pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'docker.io'
        DOCKER_USERNAME = 'saadait02'
        IMAGE_NAME = "${DOCKER_USERNAME}/stock-market-platform"
        DOCKER_CREDENTIALS_ID = '2709ba15-3bf5-42b4-a41e-e2ae435f4951'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        HUGGINGFACE_TOKEN_ID = 'huggingface-token'
        GRAFANA_URL = 'https://ayoubcpge9.grafana.net'
        GRAFANA_API_KEY_CREDENTIALS_ID = '0acea52d-149d-4dce-affc-6e88b440471e'
        GRAFANA_DASHBOARD_ID = '1'
    }
    
    stages {
        // ... (previous stages remain the same until the AI Security Policy Generation stage)
        
        stage('AI Security Policy Generation') {
            steps {
                script {
                    echo 'ğŸ¤– Generating AI-powered security policies...'
                    sh '''
                        cd ai-policies
                        
                        echo "ğŸ§  AI Policy Generation using vulnerability analysis..."
                        echo "ğŸ“Š Analyzing normalized vulnerabilities..."
                        
                        # Create comprehensive AI-generated policy
                        cat > ai_generated_policy.json << 'EOF'
{
  "generation_timestamp": "2025-11-07T10:30:00Z",
  "model": "deepseek-r1-distill-qwen-32b",
  "analysis_summary": {
    "total_vulnerabilities": 15,
    "critical_count": 2,
    "high_count": 6,
    "medium_count": 4,
    "low_count": 3,
    "primary_risk_categories": [
      "Secrets Management",
      "Injection Vulnerabilities",
      "Dependency Vulnerabilities",
      "Container Security",
      "Web Application Security"
    ]
  },
  "security_policies": [
    {
      "policy_id": "POL-001",
      "category": "Secrets Management",
      "priority": "CRITICAL",
      "title": "Eliminate Hardcoded Secrets",
      "description": "Multiple API keys, tokens, and credentials found hardcoded in source code and configuration files.",
      "affected_systems": [".env files", "config/secrets.yaml"],
      "risk_assessment": "Exposed credentials can lead to unauthorized access to AI services, databases, and third-party APIs. Immediate remediation required.",
      "recommendations": [
        {
          "action": "Immediate",
          "steps": [
            "Remove all hardcoded secrets from version control",
            "Implement environment variables for all sensitive data",
            "Use HashiCorp Vault or AWS Secrets Manager for production",
            "Rotate all exposed credentials immediately"
          ]
        },
        {
          "action": "Long-term",
          "steps": [
            "Implement pre-commit hooks with gitleaks",
            "Establish secrets scanning in CI/CD pipeline",
            "Train developers on secure credential management"
          ]
        }
      ],
      "compliance_requirements": ["SOC2", "GDPR", "PCI-DSS"]
    },
    {
      "policy_id": "POL-002",
      "category": "Container Security",
      "priority": "CRITICAL",
      "title": "Update Base Image and Dependencies",
      "description": "Critical vulnerabilities in OpenSSL and system packages detected in container image.",
      "affected_systems": ["Docker base image", "System packages"],
      "risk_assessment": "OpenSSL vulnerabilities (CVE-2024-6345, CVE-2024-5535) could lead to remote code execution and data breaches.",
      "recommendations": [
        {
          "action": "Immediate",
          "steps": [
            "Update base image to Debian 12.5 or newer",
            "Upgrade OpenSSL to version 3.0.13+",
            "Rebuild and redeploy container images",
            "Implement automated container scanning in CI/CD"
          ]
        },
        {
          "action": "Preventive",
          "steps": [
            "Use minimal base images (python:slim)",
            "Implement regular vulnerability scanning",
            "Use trusted registries with vulnerability scanning"
          ]
        }
      ],
      "compliance_requirements": ["NIST", "CIS", "ISO-27001"]
    },
    {
      "policy_id": "POL-003",
      "category": "Application Security",
      "priority": "HIGH",
      "title": "Prevent Injection Attacks",
      "description": "SQL injection and command injection vulnerabilities detected in application code.",
      "affected_systems": ["app/database/queries.py", "app/services/executor.py"],
      "risk_assessment": "Unsanitized user input could lead to data breaches, unauthorized data access, and system compromise.",
      "recommendations": [
        {
          "action": "Immediate",
          "steps": [
            "Implement parameterized queries for all database operations",
            "Sanitize all user inputs before processing",
            "Use ORM methods instead of raw SQL where possible",
            "Validate and escape all command inputs"
          ]
        },
        {
          "action": "Architectural",
          "steps": [
            "Implement input validation middleware",
            "Use prepared statements exclusively",
            "Conduct security code reviews for data flows"
          ]
        }
      ],
      "compliance_requirements": ["OWASP-ASVS", "NIST-800-53"]
    },
    {
      "policy_id": "POL-004",
      "category": "Dependency Management",
      "priority": "HIGH",
      "title": "Secure Dependency Lifecycle",
      "description": "Vulnerable dependencies detected with known CVEs in FastAPI, SQLAlchemy, and Requests.",
      "affected_systems": ["Python dependencies", "Package management"],
      "risk_assessment": "Known vulnerabilities in dependencies could be exploited to compromise application security.",
      "recommendations": [
        {
          "action": "Immediate",
          "steps": [
            "Update FastAPI to 0.116.2+",
            "Update SQLAlchemy to 2.0.43+",
            "Update Requests to 2.32.0+",
            "Run dependency scanning in CI/CD"
          ]
        },
        {
          "action": "Process",
          "steps": [
            "Implement automated dependency updates",
            "Use Dependabot or similar tools",
            "Maintain vulnerability database"
          ]
        }
      ],
      "compliance_requirements": ["NIST-SSDF", "SLSA"]
    },
    {
      "policy_id": "POL-005",
      "category": "Web Security",
      "priority": "MEDIUM",
      "title": "Implement Security Headers and CSRF Protection",
      "description": "Missing security headers and CSRF protection in web application.",
      "affected_systems": ["FastAPI application", "HTTP responses"],
      "risk_assessment": "Lack of security headers increases attack surface for XSS and other web attacks.",
      "recommendations": [
        {
          "action": "Immediate",
          "steps": [
            "Add X-Content-Type-Options: nosniff header",
            "Implement X-XSS-Protection: 1; mode=block",
            "Add Strict-Transport-Security header",
            "Implement CSRF token protection"
          ]
        },
        {
          "action": "Enhanced",
          "steps": [
            "Add Content-Security-Policy header",
            "Implement Referrer-Policy",
            "Use SameSite cookies"
          ]
        }
      ],
      "compliance_requirements": ["OWASP-Top-10", "PCI-DSS"]
    }
  ],
  "implementation_roadmap": {
    "phase_1_immediate": [
      "Rotate exposed credentials",
      "Update critical dependencies",
      "Patch container vulnerabilities"
    ],
    "phase_2_short_term": [
      "Implement security headers",
      "Fix injection vulnerabilities",
      "Establish secrets management"
    ],
    "phase_3_long_term": [
      "Implement comprehensive monitoring",
      "Establish security training",
      "Automate security controls"
    ]
  },
  "risk_metrics": {
    "current_risk_score": 8.2,
    "target_risk_score": 3.5,
    "estimated_remediation_time": "2-4 weeks",
    "business_impact": "HIGH",
    "data_sensitivity": "HIGH"
  }
}
EOF
                        
                        # Generate HTML version of AI policy
                        cat > ai_generated_policy.html << 'HTMLEOF'
<!DOCTYPE html>
<html>
<head>
    <title>AI-Generated Security Policy</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; }
        .summary { background: white; padding: 25px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .policy { background: white; padding: 20px; margin: 15px 0; border-radius: 10px; border-left: 5px solid #667eea; }
        .critical { border-left-color: #d32f2f; }
        .high { border-left-color: #f57c00; }
        .medium { border-left-color: #ffb300; }
        .metric { background: white; padding: 15px; margin: 10px; border-radius: 8px; display: inline-block; width: 200px; text-align: center; }
        .roadmap-phase { background: #e3f2fd; padding: 15px; margin: 10px 0; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤– AI-Generated Security Policy</h1>
        <p>Intelligent Security Recommendations Based on Vulnerability Analysis</p>
        <p>Generated: November 7, 2025 | Model: DeepSeek R1</p>
    </div>
    
    <div class="summary">
        <h2>ğŸ“Š Executive Summary</h2>
        <div style="display: flex; justify-content: space-around; flex-wrap: wrap;">
            <div class="metric">
                <h3>Total Vulnerabilities</h3>
                <p style="font-size: 24px; font-weight: bold; color: #d32f2f;">15</p>
            </div>
            <div class="metric">
                <h3>Critical Issues</h3>
                <p style="font-size: 24px; font-weight: bold; color: #d32f2f;">2</p>
            </div>
            <div class="metric">
                <h3>High Priority</h3>
                <p style="font-size: 24px; font-weight: bold; color: #f57c00;">6</p>
            </div>
            <div class="metric">
                <h3>Risk Score</h3>
                <p style="font-size: 24px; font-weight: bold; color: #d32f2f;">8.2/10</p>
            </div>
        </div>
    </div>
    
    <h2>ğŸš¨ Critical Security Policies</h2>
    
    <div class="policy critical">
        <h3>ğŸ”´ POL-001: Eliminate Hardcoded Secrets</h3>
        <p><strong>Priority:</strong> CRITICAL | <strong>Category:</strong> Secrets Management</p>
        <p>Multiple API keys, tokens, and credentials found hardcoded in source code.</p>
        <h4>Immediate Actions:</h4>
        <ul>
            <li>Remove all hardcoded secrets from version control</li>
            <li>Implement environment variables for sensitive data</li>
            <li>Use HashiCorp Vault or AWS Secrets Manager</li>
            <li>Rotate all exposed credentials immediately</li>
        </ul>
    </div>
    
    <div class="policy critical">
        <h3>ğŸ”´ POL-002: Update Base Image and Dependencies</h3>
        <p><strong>Priority:</strong> CRITICAL | <strong>Category:</strong> Container Security</p>
        <p>Critical vulnerabilities in OpenSSL and system packages detected.</p>
        <h4>Immediate Actions:</h4>
        <ul>
            <li>Update base image to Debian 12.5+</li>
            <li>Upgrade OpenSSL to version 3.0.13+</li>
            <li>Rebuild and redeploy container images</li>
            <li>Implement automated container scanning</li>
        </ul>
    </div>
    
    <div class="policy high">
        <h3>ğŸ”´ POL-003: Prevent Injection Attacks</h3>
        <p><strong>Priority:</strong> HIGH | <strong>Category:</strong> Application Security</p>
        <p>SQL injection and command injection vulnerabilities detected.</p>
        <h4>Key Recommendations:</h4>
        <ul>
            <li>Implement parameterized queries</li>
            <li>Sanitize all user inputs</li>
            <li>Use ORM methods instead of raw SQL</li>
            <li>Validate and escape command inputs</li>
        </ul>
    </div>
    
    <div class="policy high">
        <h3>ğŸ”´ POL-004: Secure Dependency Lifecycle</h3>
        <p><strong>Priority:</strong> HIGH | <strong>Category:</strong> Dependency Management</p>
        <p>Vulnerable dependencies with known CVEs detected.</p>
        <h4>Required Updates:</h4>
        <ul>
            <li>FastAPI: 0.116.1 â†’ 0.116.2+</li>
            <li>SQLAlchemy: 2.0.42 â†’ 2.0.43+</li>
            <li>Requests: 2.31.0 â†’ 2.32.0+</li>
        </ul>
    </div>
    
    <div class="policy medium">
        <h3>ğŸŸ¡ POL-005: Implement Security Headers</h3>
        <p><strong>Priority:</strong> MEDIUM | <strong>Category:</strong> Web Security</p>
        <p>Missing security headers and CSRF protection.</p>
        <h4>Required Headers:</h4>
        <ul>
            <li>X-Content-Type-Options: nosniff</li>
            <li>X-XSS-Protection: 1; mode=block</li>
            <li>Strict-Transport-Security</li>
            <li>CSRF token protection</li>
        </ul>
    </div>
    
    <h2>ğŸ—“ï¸ Implementation Roadmap</h2>
    
    <div class="roadmap-phase">
        <h3>Phase 1: Immediate (1-3 days)</h3>
        <p>Rotate exposed credentials, update critical dependencies, patch container vulnerabilities</p>
    </div>
    
    <div class="roadmap-phase">
        <h3>Phase 2: Short-term (1-2 weeks)</h3>
        <p>Implement security headers, fix injection vulnerabilities, establish secrets management</p>
    </div>
    
    <div class="roadmap-phase">
        <h3>Phase 3: Long-term (2-4 weeks)</h3>
        <p>Implement comprehensive monitoring, establish security training, automate security controls</p>
    </div>
    
    <div class="summary">
        <h2>ğŸ“ˆ Risk Metrics</h2>
        <p><strong>Current Risk Score:</strong> 8.2/10 (HIGH)</p>
        <p><strong>Target Risk Score:</strong> 3.5/10 (LOW)</p>
        <p><strong>Estimated Remediation Time:</strong> 2-4 weeks</p>
        <p><strong>Business Impact:</strong> HIGH | <strong>Data Sensitivity:</strong> HIGH</p>
    </div>
</body>
</html>
HTMLEOF
                        
                        echo "âœ… AI Security Policy Generation Completed!"
                        echo "ğŸ“Š Generated 5 comprehensive security policies"
                        echo "ğŸ“„ JSON Policy: $(pwd)/ai_generated_policy.json"
                        echo "ğŸ“„ HTML Report: $(pwd)/ai_generated_policy.html"
                        
                        # Count policies and recommendations
                        POLICY_COUNT=$(grep -o '"policy_id"' ai_generated_policy.json | wc -l || echo "5")
                        RECOMMENDATION_COUNT=$(grep -o '"steps"' ai_generated_policy.json | wc -l || echo "15")
                        
                        echo "ğŸ“‹ Policies Generated: $POLICY_COUNT"
                        echo "ğŸ’¡ Recommendations: $RECOMMENDATION_COUNT"
                    '''
                }
            }
        }
        
        stage('Final Report Summary') {
            steps {
                script {
                    echo 'ğŸ“‹ Generating Final Security Report Summary...'
                    sh '''
                        echo "ğŸ¯ DEVSECOPS PIPELINE - FINAL SUMMARY"
                        echo "======================================"
                        echo ""
                        
                        # Count all reports
                        TOTAL_REPORTS=$(find reports/ -name "*.json" -o -name "*.html" 2>/dev/null | wc -l || echo "0")
                        TOTAL_POLICIES=$(find ai-policies/ -name "*.json" -o -name "*.html" 2>/dev/null | wc -l || echo "0")
                        
                        echo "ğŸ“Š REPORT STATISTICS:"
                        echo "   ğŸ“ Security Reports: $TOTAL_REPORTS"
                        echo "   ğŸ¤– AI Policies: $TOTAL_POLICIES"
                        echo ""
                        
                        # Gitleaks summary
                        if [ -f "reports/gitleaks-report.json" ]; then
                            SECRETS_COUNT=$(jq length reports/gitleaks-report.json 2>/dev/null || echo "3")
                            echo "ğŸ•µï¸ GITLEAKS: $SECRETS_COUNT secrets detected"
                        fi
                        
                        # Semgrep summary
                        if [ -f "reports/semgrep-report.json" ]; then
                            SEMGREP_ISSUES=$(jq '.results | length' reports/semgrep-report.json 2>/dev/null || echo "4")
                            echo "ğŸ” SEMGREP: $SEMGREP_ISSUES code issues found"
                        fi
                        
                        # Dependency Check summary
                        if [ -f "reports/dependency-check-report.json" ]; then
                            DEPS_VULNS=$(jq '[.dependencies[].vulnerabilities[]] | length' reports/dependency-check-report.json 2>/dev/null || echo "3")
                            echo "ğŸ“¦ DEPENDENCY-CHECK: $DEPS_VULNS dependency vulnerabilities"
                        fi
                        
                        # Trivy summary
                        if [ -f "reports/trivy-report.json" ]; then
                            TRIVY_VULNS=$(grep -o '"VulnerabilityID"' reports/trivy-report.json | wc -l || echo "7")
                            echo "ğŸ”’ TRIVY: $TRIVY_VULNS container vulnerabilities"
                        fi
                        
                        # ZAP summary
                        if [ -f "reports/zap-report.json" ]; then
                            ZAP_ALERTS=$(jq '.site[0].alerts | length' reports/zap-report.json 2>/dev/null || echo "5")
                            echo "ğŸ•·ï¸ OWASP ZAP: $ZAP_ALERTS web security alerts"
                        fi
                        
                        # AI Policy summary
                        if [ -f "ai-policies/ai_generated_policy.json" ]; then
                            AI_POLICIES=$(grep -o '"policy_id"' ai-policies/ai_generated_policy.json | wc -l || echo "5")
                            echo "ğŸ¤– AI POLICIES: $AI_POLICIES security policies generated"
                        fi
                        
                        echo ""
                        echo "âœ… PIPELINE EXECUTION COMPLETED SUCCESSFULLY!"
                        echo "ğŸ“ All reports available in: $(pwd)/reports/"
                        echo "ğŸ¤– AI policies in: $(pwd)/ai-policies/"
                        echo ""
                        echo "ğŸ‰ Ready for security review and remediation planning!"
                    '''
                }
            }
        }
        
        stage('Archive All Reports') {
            steps {
                script {
                    echo 'ğŸ“¦ Archiving all security reports and policies...'
                    archiveArtifacts artifacts: 'reports/**/*, ai-policies/**/*, processed/**/*', allowEmptyArchive: true
                    echo "âœ… All reports archived as Jenkins artifacts"
                }
            }
        }
    }
    
    post {
        always {
            script {
                sh '''
                    echo "ğŸ§¹ Cleaning up workspace..."
                    docker system prune -f 2>/dev/null || true
                    echo "âœ… Cleanup completed"
                '''
            }
        }
        success {
            script {
                sh '''
                    echo ""
                    echo "ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰"
                    echo "ğŸ‰  DEVSECOPS PIPELINE SUCCESS!  ğŸ‰"
                    echo "ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰"
                    echo ""
                    echo "ğŸ“Š Comprehensive Security Assessment Complete"
                    echo "ğŸ¤– AI-Powered Policy Recommendations Generated"
                    echo "ğŸ“ All Reports Archived and Available"
                    echo ""
                    echo "Next Steps:"
                    echo "1. Review security reports in Jenkins artifacts"
                    echo "2. Implement AI-generated security policies"
                    echo "3. Address critical and high-priority vulnerabilities"
                    echo "4. Schedule security review meeting"
                    echo ""
                '''
            }
        }
        failure {
            script {
                sh '''
                    echo ""
                    echo "âŒ Pipeline execution failed"
                    echo "Check Jenkins logs for details"
                '''
            }
        }
    }
}