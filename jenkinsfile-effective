pipeline {
    agent any
    
    environment {
        DOCKER_USERNAME = 'saadait02'
        IMAGE_NAME = "${DOCKER_USERNAME}/stock-market-platform"
        IMAGE_TAG = "${BUILD_NUMBER}"
        REPORTS_DIR = 'reports'
        PROCESSED_DIR = 'processed'
        AI_POLICIES_DIR = 'ai-policies'
    }
    
    stages {
        stage('Setup Environment') {
            steps {
                script {
                    echo "üîß Setting up environment..."
                    sh '''
                        mkdir -p reports processed ai-policies
                        chmod 755 reports processed ai-policies
                        echo "Environment setup completed"
                    '''
                }
            }
        }
        
        stage('Pre-commit Security') {
            parallel {
                stage('Secrets Scanning - Gitleaks') {
                    steps {
                        script {
                            echo "üïµÔ∏è Scanning for secrets with Gitleaks..."
                            sh '''
                                echo "Running Gitleaks secrets detection..."
                                docker run --rm -v $(pwd):/repo zricethezav/gitleaks:latest detect \
                                    --source=/repo \
                                    --report-format=json \
                                    --report-path=/repo/reports/gitleaks-report.json \
                                    --no-git --verbose || true
                                
                                echo "üìä Gitleaks scan results:"
                                if [ -f reports/gitleaks-report.json ]; then
                                    echo "Report generated successfully"
                                    wc -l reports/gitleaks-report.json
                                else
                                    echo "No secrets found - creating empty report"
                                    echo '[]' > reports/gitleaks-report.json
                                fi
                            '''
                        }
                    }
                }
                
                stage('SAST - Semgrep') {
                    steps {
                        script {
                            echo "üîç Running SAST analysis with Semgrep..."
                            sh '''
                                echo "Running Semgrep static analysis..."
                                docker run --rm -v $(pwd):/src returntocorp/semgrep:latest \
                                    semgrep scan --config=p/python \
                                    --json --output=/src/reports/semgrep-report.json /src || true
                                
                                echo "üìä Semgrep scan results:"
                                if [ -f reports/semgrep-report.json ]; then
                                    echo "SAST report generated successfully"
                                    cat reports/semgrep-report.json | jq '.results | length' || echo "Processing complete"
                                else
                                    echo "No SAST issues found - creating empty report"
                                    echo '{"results": []}' > reports/semgrep-report.json
                                fi
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Build Application') {
            steps {
                script {
                    echo "üê≥ Building Docker image..."
                    sh '''
                        echo "Building main application image..."
                        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
                        docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
                        
                        echo "‚úÖ Image built successfully:"
                        docker images ${IMAGE_NAME}:${IMAGE_TAG}
                    '''
                }
            }
        }
        
        stage('Security Scanning') {
            parallel {
                stage('Container Security - Trivy') {
                    steps {
                        script {
                            echo "üõ°Ô∏è Running container security scan with Trivy..."
                            sh '''
                                echo "Scanning Docker image for vulnerabilities..."
                                docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
                                    -v $(pwd)/reports:/reports \
                                    aquasec/trivy image \
                                    --format json \
                                    --output /reports/trivy-report.json \
                                    ${IMAGE_NAME}:${IMAGE_TAG} || true
                                
                                echo "üìä Trivy scan results:"
                                if [ -f reports/trivy-report.json ]; then
                                    echo "Container security report generated"
                                    cat reports/trivy-report.json | jq '.Results[]?.Vulnerabilities? | length' || echo "Processing complete"
                                else
                                    echo "Creating empty Trivy report"
                                    echo '{"Results": []}' > reports/trivy-report.json
                                fi
                            '''
                        }
                    }
                }
                
                stage('Dependency Security - Safety') {
                    steps {
                        script {
                            echo "üì¶ Running dependency security check..."
                            sh '''
                                echo "Checking Python dependencies for vulnerabilities..."
                                docker run --rm -v $(pwd):/app -w /app ${IMAGE_NAME}:${IMAGE_TAG} \
                                    sh -c 'pip install safety && pip freeze | safety check --json --output /app/reports/safety-report.json' || true
                                
                                echo "üìä Dependency scan results:"
                                if [ -f reports/safety-report.json ]; then
                                    echo "Dependency security report generated"
                                else
                                    echo "Creating empty safety report"
                                    echo '[]' > reports/safety-report.json
                                fi
                            '''
                        }
                    }
                }
            }
        }
        
        stage('Application Testing') {
            steps {
                script {
                    echo "üß™ Running application tests..."
                    sh '''
                        echo "Starting test environment..."
                        # Run tests in container
                        docker run --rm -v $(pwd):/app -w /app ${IMAGE_NAME}:${IMAGE_TAG} \
                            sh -c 'python -m pytest tests/ -v --tb=short --json-report --json-report-file=/app/reports/test-results.json' || true
                        
                        echo "üìä Test results:"
                        if [ -f reports/test-results.json ]; then
                            echo "Test report generated"
                        else
                            echo "No tests found - creating placeholder report"
                            echo '{"tests": [], "summary": {"total": 0, "passed": 0, "failed": 0}}' > reports/test-results.json
                        fi
                    '''
                }
            }
        }
        
        stage('Normalize Security Reports') {
            steps {
                script {
                    echo "üìä Normalizing security reports..."
                    sh '''
                        echo "Processing vulnerability reports..."
                        docker run --rm \
                            -v $(pwd)/reports:/reports \
                            -v $(pwd)/processed:/output \
                            -v $(pwd):/app \
                            -w /app \
                            python:3.11-slim \
                            python normalize_vulnerabilities.py || true
                        
                        echo "üìä Normalization results:"
                        if [ -f processed/normalized_vulnerabilities.json ]; then
                            echo "Vulnerabilities normalized successfully"
                            cat processed/normalized_vulnerabilities.json | jq 'length'
                        else
                            echo "Creating empty normalized report"
                            mkdir -p processed
                            echo '[]' > processed/normalized_vulnerabilities.json
                        fi
                    '''
                }
            }
        }
        
        stage('AI Security Policy Generation') {
            steps {
                script {
                    echo "ü§ñ Generating AI security policy..."
                    sh '''
                        echo "Analyzing vulnerabilities with AI..."
                        docker run --rm \
                            -v $(pwd)/processed:/app/processed \
                            -v $(pwd)/ai-policies:/app/ai-policies \
                            -v $(pwd):/app \
                            -w /app \
                            python:3.11-slim \
                            python generate_ai_policy.py || true
                        
                        echo "üìä AI Policy Generation results:"
                        if [ -f ai-policies/ai_generated_policy_REAL.json ]; then
                            echo "AI security policy generated successfully"
                            cat ai-policies/ai_generated_policy_REAL.json | jq '.vulnerability_count, .risk_assessment, .deployment_recommendation.status'
                        else
                            echo "Creating default AI policy"
                            mkdir -p ai-policies
                            echo '{"status": "no_vulnerabilities", "recommendation": "deployment_approved"}' > ai-policies/ai_generated_policy_REAL.json
                        fi
                    '''
                }
            }
        }
        
        stage('Deploy Application') {
            steps {
                script {
                    echo "üöÄ Deploying application..."
                    sh '''
                        echo "Starting application deployment..."
                        docker-compose down || true
                        docker-compose up -d
                        
                        echo "‚è≥ Waiting for services to be ready..."
                        sleep 15
                        
                        echo "üè• Health check:"
                        curl -f http://localhost:8000/api/v1/finance/health || echo "Service starting..."
                        
                        echo "üìä Deployment status:"
                        docker-compose ps
                    '''
                }
            }
        }
        
        stage('Generate Final Report') {
            steps {
                script {
                    echo "üìã Generating comprehensive security report..."
                    sh '''
                        echo "Creating final security assessment..."
                        
                        # Count vulnerabilities by severity
                        CRITICAL=$(cat processed/normalized_vulnerabilities.json | jq '[.[] | select(.severity == "CRITICAL")] | length')
                        HIGH=$(cat processed/normalized_vulnerabilities.json | jq '[.[] | select(.severity == "HIGH")] | length')
                        MEDIUM=$(cat processed/normalized_vulnerabilities.json | jq '[.[] | select(.severity == "MEDIUM")] | length')
                        
                        echo "üî• Security Summary:"
                        echo "   Critical: $CRITICAL"
                        echo "   High: $HIGH" 
                        echo "   Medium: $MEDIUM"
                        
                        # Deployment decision
                        if [ "$CRITICAL" -gt 0 ]; then
                            echo "‚ùå DEPLOYMENT BLOCKED: Critical vulnerabilities found"
                            echo "deployment_blocked" > reports/deployment_decision.txt
                        elif [ "$HIGH" -gt 5 ]; then
                            echo "‚ö†Ô∏è DEPLOYMENT CONDITIONAL: Many high severity issues"
                            echo "deployment_conditional" > reports/deployment_decision.txt
                        else
                            echo "‚úÖ DEPLOYMENT APPROVED: No critical issues"
                            echo "deployment_approved" > reports/deployment_decision.txt
                        fi
                        
                        echo "üìä Pipeline completed successfully!"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo "üìä Archiving reports and artifacts..."
            archiveArtifacts artifacts: 'reports/*.json, processed/*.json, ai-policies/*.json', allowEmptyArchive: true
            
            script {
                if (fileExists('reports/test-results.json')) {
                    echo "Publishing test results..."
                }
                
                echo "üìä Final Pipeline Summary:"
                sh '''
                    echo "=== DevSecOps Pipeline Results ==="
                    echo "Build Number: ${BUILD_NUMBER}"
                    echo "Image: ${IMAGE_NAME}:${IMAGE_TAG}"
                    echo "Reports generated:"
                    ls -la reports/ || echo "No reports directory"
                    echo "AI policies:"
                    ls -la ai-policies/ || echo "No AI policies directory"
                    echo "=== End Summary ==="
                '''
            }
        }
        
        success {
            echo "‚úÖ DevSecOps Pipeline completed successfully!"
        }
        
        failure {
            echo "‚ùå DevSecOps Pipeline failed! Check logs for details."
        }
        
        cleanup {
            echo "üßπ Cleaning up temporary resources..."
            sh '''
                # Clean up old images (keep last 3 builds)
                docker images ${IMAGE_NAME} --format "{{.Tag}}" | tail -n +4 | xargs -r docker rmi ${IMAGE_NAME}: || true
                
                # Clean up old reports
                find reports/ -name "*.json" -mtime +7 -delete || true
                
                echo "Cleanup completed"
            '''
        }
    }
}